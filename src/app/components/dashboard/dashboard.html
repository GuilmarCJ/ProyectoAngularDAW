<div class="dashboard-container">
  <!-- Bot√≥n de men√∫ hamburguesa -->
  <button class="menu-toggle" (click)="toggleSidebar()">‚ò∞</button>

  <!-- Sidebar mejorado -->
  <nav class="sidebar" [class.open]="isSidebarOpen">
  <div class="sidebar-header">
    <h3>Soluciones Industriales</h3>
  </div>
  <ul>
    <li><a href="#" class="active">üè† Inicio</a></li>
    
    
    <!-- Opci√≥n de Gesti√≥n de Usuarios (solo para admin) -->
    <!-- En el sidebar del dashboard -->
<li *ngIf="esAdministrador()">
  <a [routerLink]="['/gestion-usuarios']">üë• Gesti√≥n de Usuarios</a>
</li>
    
    <li><a href="#">‚öôÔ∏è Configuraci√≥n</a></li>
  </ul>
  <div class="sidebar-footer">
    <p>Sistema v2.1</p>
  </div>
</nav>

  <!-- Contenido principal -->
  <div class="main-content" [class.shift]="isSidebarOpen">
    <header class="dashboard-header">
      <div class="header-left">
        <h1>Gesti√≥n de Materiales</h1>
        <p class="header-subtitle">Sistema de control de inventario</p>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar">
            {{ username?.charAt(0) | uppercase }}
          </div>
          <div class="user-details">
            <span class="user-name">{{ username }}</span>
            <span class="user-role">{{ rol }}</span>
          </div>
          <button (click)="logout()" class="btn-logout" title="Cerrar sesi√≥n">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </header>

    <!-- Filtros y b√∫squeda -->
    <div class="controls-row">
  <div class="search-box">
    <i class="fas fa-search"></i>
    <input 
      type="text" 
      placeholder="Buscar por ID o Material" 
      [(ngModel)]="filtroGeneral"
      (keyup.enter)="aplicarFiltros()" />
  </div>
  <div class="filter-controls">
    <select [(ngModel)]="filtroLocal" [disabled]="usuarioRol !== 'ADMINISTRADOR'">
      <option value="">Todos los locales</option>
      <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
    </select>
    <select [(ngModel)]="filtroEstado">
      <option value="">Todos los estados</option>
      <option value="ACTIVO">ACTIVO</option>
      <option value="PENDIENTE">PENDIENTE</option>
      <option value="INACTIVO">INACTIVO</option>
    </select>
    <button class="btn-filter" (click)="aplicarFiltros()">
      <i class="fas fa-filter"></i> Filtrar
    </button>
    <button class="btn-clear" (click)="limpiarFiltros()" *ngIf="filtrosActivos">
      <i class="fas fa-times"></i> Limpiar
    </button>
  </div>
</div>

    <!-- Tarjetas de estad√≠sticas mejoradas -->
    <section class="stats-cards">
      <div class="card stat-card">
        <div class="card-icon total">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="card-content">
          <h3>{{ materialesFiltrados.length }}</h3>
          <p>Total Materiales</p>
        </div>
      </div>
      
      <div class="card stat-card pending">
        <div class="card-icon">
          <i class="fas fa-clock"></i>
        </div>
        <div class="card-content">
          <h3>{{ getPendientes() }}</h3>
          <p>Pendientes</p>
          <span class="card-percentage">{{ getPendientes() / materialesFiltrados.length * 100 | number:'1.0-0' }}%</span>
        </div>
      </div>
      
      <div class="card stat-card completed">
        <div class="card-icon">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="card-content">
          <h3>{{ getActivos() }}</h3>
          <p>Completados</p>
          <span class="card-percentage">{{ getActivos() / materiales.length * 100 | number:'1.0-0' }}%</span>
        </div>
      </div>
      
      <div class="card stat-card updated">
        <div class="card-icon">
          <i class="fas fa-sync-alt"></i>
        </div>
        <div class="card-content">
          <h3>{{ materiales.length - getPendientes() - getActivos() }}</h3>
          <p>Actualizados</p>
          <span class="card-updated">Hoy: {{ materiales.length > 0 ? '4' : '0' }}</span>
        </div>
      </div>
    </section>

    <!-- Resumen de actividad -->
    <section class="activity-summary">
      <div class="summary-header">
        <h2>Resumen de Actividad</h2>
        <button class="btn-refresh" (click)="loadMateriales()">
          <i class="fas fa-redo"></i> Actualizar
        </button>
      </div>
      
      <div class="summary-content">
        <div class="summary-item">
          <span class="summary-label">√öltima actualizaci√≥n:</span>
          <span class="summary-value">{{ getLastUpdate() }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Materiales sin conteo:</span>
          <span class="summary-value">{{ getPendientes() }}</span>
        </div>
        <div class="summary-item">
          <span class="summary-label">Pr√≥xima auditor√≠a:</span>
          <span class="summary-value">15 Mar 2024</span>
        </div>
      </div>
    </section>

    <div class="dashboard-content">
      <div *ngIf="isLoading" class="loading">
        <div class="loading-spinner"></div>
        <p>Cargando materiales, por favor espere...</p>
      </div>

      <div *ngIf="errorMessage" class="error-message">
        <i class="fas fa-exclamation-triangle"></i>
        <p>{{ errorMessage }}</p>
        <button (click)="loadMateriales()" class="btn-retry">Reintentar</button>
      </div>

      <div *ngIf="!isLoading && !errorMessage">
        <div class="table-header">
          <h2>Lista de Materiales</h2>
          <div class="table-actions">
            <button class="btn-export">
              <i class="fas fa-file-export"></i> Exportar
            </button>
            <button class="btn-print">
              <i class="fas fa-print"></i> Imprimir
            </button>
          </div>
        </div>

        <div class="table-container">
          <table class="materiales-table">
            <thead>
              <tr>
                <th>ID <i class="fas fa-sort"></i></th>
                <th>Material <i class="fas fa-sort"></i></th>
                <th>Descripci√≥n</th>
                <th>Local <i class="fas fa-sort"></i></th>
                <th class="text-right">Cantidad <i class="fas fa-sort"></i></th>
                <th class="text-right">Conteo</th>
                <th class="text-right">Reconteo</th>
                <th>√öltima Actualizaci√≥n <i class="fas fa-sort"></i></th>
                <th>Estado <i class="fas fa-sort"></i></th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let material of materialesFiltrados" class="material-row">
                <td class="id-cell">{{ material.id }}</td>
                <td class="material-name">{{ material.material }}</td>
                <td class="description-cell">{{ material.descripcion || '-' }}</td>
                <td>
                  <span class="local-badge" [class.huachipa]="material.local === 'HUACHIPA'" 
                    [class.sullana]="material.local === 'SULLANA'">
                    {{ material.local }}
                  </span>
                </td>
                <td class="text-right">{{ material.cantidad }}</td>
                <td class="text-right">{{ material.conteo || '-' }}</td>
                <td class="text-right">{{ material.reconteo || '-' }}</td>
                <td>{{ formatDate(material.fecReg) }}</td>
                <td>
                  <span [class]="'status-badge ' + getEstadoClass(material.estado)">
                    <i class="badge-icon" [class]="getEstadoIcon(material.estado)"></i>
                    {{ material.estado || 'PENDIENTE' }}
                  </span>
                </td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-conteo" (click)="openConteoModal(material.id)">
                      <i class="fas fa-clipboard-check"></i> Conteo
                    </button>
                    <button class="btn-reconteo" (click)="openReconteoModal(material.id)">
                      <i class="fas fa-redo"></i> Reconteo
                    </button>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div *ngIf="materialesFiltrados.length === 0" class="no-data">
            <i class="fas fa-inbox"></i>
            <h3>No se encontraron materiales</h3>
            <p>No hay materiales registrados en el sistema</p>
          </div>
        </div>

        <!-- Paginaci√≥n -->
        <div class="pagination" *ngIf="materiales.length > 0">
          <button class="pagination-btn" disabled>
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="pagination-info">P√°gina 1 de 1</span>
          <button class="pagination-btn">
            <i class="fas fa-chevron-right"></i>
          </button>
          <span class="pagination-total">Mostrando {{ materialesFiltrados.length }} registros</span>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer class="dashboard-footer">
      <p>¬© 2024 Soluciones Industriales del Pac√≠fico S.A.C. - Sistema de Gesti√≥n de Inventarios</p>
    </footer>

    <!-- Modal de Conteo -->
    <div class="modal-backdrop" *ngIf="showConteoModal" (click)="closeConteoModal()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Registrar Conteo</h2>
          <button class="modal-close" (click)="closeConteoModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form (ngSubmit)="registrarConteo()" #conteoForm="ngForm">
          <!-- ID solo lectura -->
          <div class="form-group">
            <label for="materialId">ID Material:</label>
            <input 
              type="number" 
              id="materialId" 
              [(ngModel)]="conteoData.materialId" 
              name="materialId" 
              readonly />
          </div>

          <!-- Cantidad -->
          <div class="form-group">
            <label for="conteo">Cantidad:</label>
            <input 
              type="number" 
              id="conteo"
              [(ngModel)]="conteoData.conteo" 
              name="conteo" 
              required />
          </div>

          <!-- Observaci√≥n -->
          <div class="form-group">
            <label for="obs">Observaci√≥n:</label>
            <input 
              type="text" 
              id="obs"
              [(ngModel)]="conteoData.obs" 
              name="obs" />
          </div>

          <!-- üëá Campo extra SOLO para ADMINISTRADOR -->
          <div class="form-group" *ngIf="usuarioRol === 'ADMINISTRADOR'">
            <label for="local">Seleccione Local:</label>
            <select 
              id="local"
              [(ngModel)]="conteoData.local" 
              name="local" 
              required>
              <option value="" disabled selected>-- Seleccione un local --</option>
              <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeConteoModal()">Cancelar</button>
            <button type="submit" [disabled]="conteoForm.invalid" class="btn-primary">Registrar</button>
          </div>
        </form>

        <p class="modal-message">{{ mensajeConteo }}</p>
      </div>
    </div>

    <!-- Modal de Reconteo -->
    <div class="modal-backdrop" *ngIf="showReconteoModal" (click)="closeReconteoModal()">
      <div class="modal-container" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Registrar Reconteo</h2>
          <button class="modal-close" (click)="closeReconteoModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <form (ngSubmit)="registrarReconteo()" #reconteoForm="ngForm">
          <!-- ID solo lectura -->
          <div class="form-group">
            <label for="reconteoMaterialId">ID Material:</label>
            <input 
              type="number" 
              id="reconteoMaterialId" 
              [(ngModel)]="reconteoData.materialId" 
              name="materialId" 
              readonly />
          </div>

          <!-- Reconteo -->
          <div class="form-group">
            <label for="reconteo">Reconteo:</label>
            <input 
              type="number" 
              id="reconteo"
              [(ngModel)]="reconteoData.reconteo" 
              name="reconteo" 
              required />
          </div>

          <!-- Observaci√≥n -->
          <div class="form-group">
            <label for="reconteoObs">Observaci√≥n:</label>
            <input 
              type="text" 
              id="reconteoObs"
              [(ngModel)]="reconteoData.obs" 
              name="obs" />
          </div>

          <!-- üëá Campo extra SOLO para ADMINISTRADOR -->
          <div class="form-group" *ngIf="usuarioRol === 'ADMINISTRADOR'">
            <label for="reconteoLocal">Seleccione Local:</label>
            <select 
              id="reconteoLocal"
              [(ngModel)]="reconteoData.local" 
              name="local" 
              required>
              <option value="" disabled selected>-- Seleccione un local --</option>
              <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
            </select>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" (click)="closeReconteoModal()">Cancelar</button>
            <button type="submit" [disabled]="reconteoForm.invalid" class="btn-primary">Registrar</button>
          </div>
        </form>

        <p class="modal-message">{{ mensajeReconteo }}</p>
      </div>
    </div>
  </div>

<!-- Modales de Gesti√≥n de Usuarios -->

<!-- Modal Crear Usuario -->
<div class="a" *ngIf="showCrearUsuarioModal" (click)="closeCrearUsuarioModal()">
  <div class="b" (click)="$event.stopPropagation()">
    <div class="c">
      <h2>Crear Inventariador</h2>
      <button class="c-close" (click)="closeCrearUsuarioModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form (ngSubmit)="crearUsuario()" #crearUsuarioForm="ngForm">
      <div class="c-group">
        <label for="username">Usuario</label>
        <input type="text" id="username"
          [(ngModel)]="nuevoUsuario.username" 
          name="username" required minlength="3"
          placeholder="Ingrese usuario..." />
      </div>

      <div class="c-group">
        <label for="password">Contrase√±a</label>
        <input type="password" id="password"
          [(ngModel)]="nuevoUsuario.password" 
          name="password" required minlength="6"
          placeholder="Ingrese contrase√±a..." />
      </div>

      <div class="c-group">
        <label for="nombreCompleto">Nombre Completo</label>
        <input type="text" id="nombreCompleto"
          [(ngModel)]="nuevoUsuario.nombreCompleto" 
          name="nombreCompleto" required
          placeholder="Ingrese nombre completo..." />
      </div>

      <div class="c-group">
        <label for="local">Local</label>
        <select id="local" class="c-select"
          [(ngModel)]="nuevoUsuario.local" 
          name="local" required>
          <option value="" disabled selected>-- Seleccione un local --</option>
          <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
        </select>
      </div>

      <div class="c-group">
        <label for="almacen">Almac√©n</label>
        <input type="text" id="almacen"
          [(ngModel)]="nuevoUsuario.almacen" 
          name="almacen" required
          placeholder="Ingrese almac√©n..." />
      </div>

      <div class="c-actions">
        <button type="button" class="c-btn-sec" (click)="closeCrearUsuarioModal()">Cancelar</button>
        <button type="submit" [disabled]="crearUsuarioForm.invalid" class="c-btn">Crear Usuario</button>
      </div>
    </form>

    <p class="c-msg" *ngIf="mensajeUsuario">{{ mensajeUsuario }}</p>
  </div>
</div>


<!-- Modal Modificar Usuario -->
<div class="modal-backdrop" *ngIf="showCrearUsuarioModal" (click)="closeCrearUsuarioModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Crear Inventariador</h2>
      <button class="modal-close" (click)="closeCrearUsuarioModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form (ngSubmit)="crearUsuario()" #crearUsuarioForm="ngForm">
      <div class="form-group">
        <label for="username">Usuario:</label>
        <input 
          type="text" 
          id="username"
          [(ngModel)]="nuevoUsuario.username" 
          name="username" 
          required 
          minlength="3" />
      </div>

      <div class="form-group">
        <label for="password">Contrase√±a:</label>
        <input 
          type="password" 
          id="password"
          [(ngModel)]="nuevoUsuario.password" 
          name="password" 
          required 
          minlength="6" />
      </div>

      <div class="form-group">
        <label for="nombreCompleto">Nombre Completo:</label>
        <input 
          type="text" 
          id="nombreCompleto"
          [(ngModel)]="nuevoUsuario.nombreCompleto" 
          name="nombreCompleto" 
          required />
      </div>

      <div class="form-group">
        <label for="local">Local:</label>
        <select 
          id="local"
          [(ngModel)]="nuevoUsuario.local" 
          name="local" 
          required>
          <option value="" disabled selected>-- Seleccione un local --</option>
          <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
        </select>
      </div>

      <div class="form-group">
        <label for="almacen">Almac√©n:</label>
        <input 
          type="text" 
          id="almacen"
          [(ngModel)]="nuevoUsuario.almacen" 
          name="almacen" 
          required />
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeCrearUsuarioModal()">Cancelar</button>
        <button type="submit" [disabled]="crearUsuarioForm.invalid" class="btn-primary">Crear Usuario</button>
      </div>
    </form>

    <p class="modal-message">{{ mensajeUsuario }}</p>
  </div>
</div>

<!-- Modal Modificar Usuario -->
<div class="modal-backdrop" *ngIf="showModificarUsuarioModal" (click)="closeModificarUsuarioModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Modificar Inventariador</h2>
      <button class="modal-close" (click)="closeModificarUsuarioModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <form (ngSubmit)="modificarUsuario()" #modificarUsuarioForm="ngForm">
      <div class="form-group">
        <label for="modificarUsername">Usuario:</label>
        <input 
          type="text" 
          id="modificarUsername"
          [(ngModel)]="usuarioSeleccionado.username" 
          name="username" 
          readonly />
      </div>

      <div class="form-group">
        <label for="modificarPassword">Nueva Contrase√±a:</label>
        <input 
          type="password" 
          id="modificarPassword"
          [(ngModel)]="usuarioSeleccionado.password" 
          name="password" 
          required 
          minlength="6" />
      </div>

      <div class="form-group">
        <label for="modificarNombreCompleto">Nombre Completo:</label>
        <input 
          type="text" 
          id="modificarNombreCompleto"
          [(ngModel)]="usuarioSeleccionado.nombreCompleto" 
          name="nombreCompleto" 
          required />
      </div>

      <div class="form-group">
        <label for="modificarLocal">Local:</label>
        <select 
          id="modificarLocal"
          [(ngModel)]="usuarioSeleccionado.local" 
          name="local" 
          required>
          <option value="" disabled selected>-- Seleccione un local --</option>
          <option value="HUACHIPA">HUACHIPA</option>
              <option value="HUACHIPA">HUACHIPA13</option>
              <option value="SULLANA">TRUJILLO</option>
              <option value="SULLANA">SULLANA</option>
              <option value="SULLANA">ATE</option>
              <option value="SULLANA">CALLAO</option>
        </select>
      </div>

      <div class="form-group">
        <label for="modificarAlmacen">Almac√©n:</label>
        <input 
          type="text" 
          id="modificarAlmacen"
          [(ngModel)]="usuarioSeleccionado.almacen" 
          name="almacen" 
          required />
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-secondary" (click)="closeModificarUsuarioModal()">Cancelar</button>
        <button type="submit" [disabled]="modificarUsuarioForm.invalid" class="btn-primary">Modificar Usuario</button>
      </div>
    </form>

    <p class="modal-message">{{ mensajeUsuario }}</p>
  </div>
</div>

<!-- Modal Eliminar Usuario -->
<div class="modal-backdrop" *ngIf="showEliminarUsuarioModal" (click)="closeEliminarUsuarioModal()">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Eliminar Inventariador</h2>
      <button class="modal-close" (click)="closeEliminarUsuarioModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="modal-body">
      <p>¬øEst√° seguro de que desea eliminar al inventariador <strong>{{ usuarioSeleccionado.nombreCompleto }}</strong> ({{ usuarioSeleccionado.username }})?</p>
      <p>Esta acci√≥n no se puede deshacer.</p>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn-secondary" (click)="closeEliminarUsuarioModal()">Cancelar</button>
      <button type="button" class="btn-danger" (click)="confirmarEliminarUsuario()">Eliminar Usuario</button>
    </div>

    <p class="modal-message">{{ mensajeUsuario }}</p>
  </div>
</div>
  
</div>